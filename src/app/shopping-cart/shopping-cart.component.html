<!-- Toast Messages -->
<p-toast></p-toast>

<!-- Business Services Section -->
<div class="business-services-section" *ngIf="businessInfo">
  <p-card subheader="{{businessInfo.businessName}}" styleClass="business-info-card">
    <p class="business-description">{{businessInfo.businessDescription}}</p>
    
    <div class="business-contact-info">
      <p-chip *ngIf="businessInfo.phone" icon="pi pi-phone" label="{{businessInfo.phone}}"></p-chip>
      <p-chip *ngIf="businessInfo.email" icon="pi pi-envelope" label="{{businessInfo.email}}"></p-chip>
    </div>
    
    <p-divider align="center">
      <p-chip label="Services" icon="pi pi-shopping-cart"></p-chip>
    </p-divider>
    
    <div *ngIf="isLoadingBusinessData" class="loading-container">
      <p-progressSpinner styleClass="custom-spinner"></p-progressSpinner>
      <p>Loading business services...</p>
    </div>
    
    <div *ngIf="!isLoadingBusinessData && businessServices.length > 0" class="services-grid">
      <div *ngFor="let service of businessServices" class="service-container">
        <p-card styleClass="service-card">
          <ng-template pTemplate="header">
            <img *ngIf="service.serviceImageUrl" [src]="service.serviceImageUrl" alt="Service Image" class="service-image">
            <div *ngIf="!service.serviceImageUrl" class="service-image-placeholder">
              <i class="pi pi-image"></i>
            </div>
          </ng-template>
          
          <ng-template pTemplate="title">
            <span class="service-name">{{service.serviceName}}</span>
          </ng-template>
          
          <ng-template pTemplate="subtitle">
            <div class="service-details">
              <p-tag severity="info" icon="pi pi-clock" value="{{service.duration}} min"></p-tag>
              <p-tag severity="success" icon="pi pi-dollar" value="{{service.price | currency:service.currency}}"></p-tag>
            </div>
          </ng-template>
          
          <p class="service-description">{{service.serviceDescription}}</p>
          
          <ng-template pTemplate="footer">
            <div class="service-actions">
              <div class="action-buttons">
                <p-button 
                  *ngIf="!isServiceInCart(service)" 
                  label="Add to Cart" 
                  icon="pi pi-cart-plus" 
                  (onClick)="addServiceToCart(service)"
                  styleClass="p-button-sm">
                </p-button>
                
                <div *ngIf="isServiceInCart(service)" class="quantity-controls">
                  <p-button 
                    icon="pi pi-minus" 
                    (onClick)="decrementServiceQuantity(service)" 
                    styleClass="p-button-sm p-button-outlined"
                    severity="secondary">
                  </p-button>
                  <p-chip [label]="getServiceQuantityInCart(service).toString()" styleClass="quantity-chip"></p-chip>
                  <p-button 
                    icon="pi pi-plus" 
                    (onClick)="incrementServiceQuantity(service)" 
                    styleClass="p-button-sm p-button-outlined"
                    severity="secondary">
                  </p-button>
                </div>
              </div>
              
              <p-button 
                label="Reviews" 
                icon="pi pi-star" 
                (onClick)="openReviewsDialog(service)"
                styleClass="p-button-sm p-button-outlined p-button-secondary">
              </p-button>
            </div>
          </ng-template>
        </p-card>
      </div>
    </div>
    
    <p-message *ngIf="!isLoadingBusinessData && businessServices.length === 0" 
               severity="info" 
               text="No services available at this time.">
    </p-message>
  </p-card>
</div>

<!-- Shopping Cart Section -->
<div class="cart-container" *ngIf="dataService.CartItems.length > 0; else emptyCart">
  <p-card header="Your Service Cart" styleClass="cart-card">
    <p-table [value]="dataService.CartItems" styleClass="p-datatable-sm custom-cart-table">
      <ng-template pTemplate="header">
        <tr>
          <th>Image</th>
          <th>Service Name</th>
          <th>Unit Price</th>
          <th>Quantity</th>
          <th>Total</th>
          <th>Remove</th>
        </tr>
      </ng-template>
      
      <ng-template pTemplate="body" let-item>
        <tr>
          <td>
        <img [src]="item.service.serviceImageUrl" alt="Service Image" class="cart-table-img" *ngIf="item.service.serviceImageUrl" />
            <i class="pi pi-image" *ngIf="!item.service.serviceImageUrl" style="font-size: 2rem; color: #ccc;"></i>
      </td>
          <td><strong>{{ item.service.serviceName }}</strong></td>
          <td>{{ item.service.servicePrice | currency:item.service.servicePriceCurrencyUnit }}</td>
          <td>
            <div class="quantity-controls">
              <p-button 
                icon="pi pi-minus" 
                (onClick)="dataService.DecrementQuantity(item.service)" 
                styleClass="p-button-sm p-button-outlined"
                severity="secondary">
              </p-button>
        <span class="qty-value">{{ item.quantity }}</span>
              <p-button 
                icon="pi pi-plus" 
                (onClick)="dataService.IncrementQuantity(item.service)" 
                styleClass="p-button-sm p-button-outlined"
                severity="secondary">
              </p-button>
            </div>
      </td>
          <td>{{ (item.service.servicePrice || 0) * item.quantity | currency:item.service.servicePriceCurrencyUnit }}</td>
          <td>
            <p-button 
              icon="pi pi-trash" 
              (onClick)="dataService.RemoveFromCart(item.service)" 
              styleClass="p-button-sm p-button-danger"
              severity="danger">
            </p-button>
      </td>
        </tr>
      </ng-template>
    </p-table>

    <ng-template pTemplate="footer">
  <div class="cart-summary">
        <p-panel header="Order Summary" styleClass="cart-summary-panel">
    <div class="cart-summary-row">
      <span>Total Items:</span>
            <p-chip [label]="dataService.itemsInCart.toString()" styleClass="summary-chip"></p-chip>
    </div>
    <div class="cart-summary-row">
      <span>Total Price:</span>
            <p-chip [label]="(totalPrice | currency) || ''" styleClass="summary-chip price-chip"></p-chip>
          </div>
                      <div class="date-selection">
              <p>Select a date for your service(s)</p>
              <p-calendar 
                [(ngModel)]="selectedDate" 
                [minDate]="minDate" 
                dateFormat="mm/dd/yy" 
                placeholder="Choose a date"
                styleClass="date-picker"
                [showIcon]="true"
                [readonlyInput]="true">
              </p-calendar>
    </div>
          <p-button 
            label="Checkout" 
            icon="pi pi-shopping-cart" 
            (onClick)="CheckOutPessed()" 
            styleClass="checkout-btn p-button-lg"
            severity="success">
          </p-button>
        </p-panel>
  </div>
    </ng-template>
  </p-card>
</div>

<!-- Customer Details Dialog -->
<p-dialog 
  header="Customer Details" 
  [(visible)]="showCustomerForm" 
  [modal]="true" 
  [style]="{ width: '50rem' }" 
  [breakpoints]="{ '1199px': '75vw', '575px': '90vw' }"
  [draggable]="false"
  [resizable]="false">
  
  <ng-template pTemplate="header">
    <div class="dialog-header">
      <i class="pi pi-user"></i>
      <span>Customer Details</span>
    </div>
  </ng-template>
  
  <p class="dialog-subtitle">Please provide your information to complete the order</p>
  
  <form [formGroup]="customerForm" (ngSubmit)="submitOrder()">
    <div class="form-grid">
      <div class="form-row">
        <p-floatlabel>
          <input 
            pInputText 
            id="name" 
            formControlName="name" 
            placeholder="Enter your full name"
            [class.ng-invalid]="customerForm.get('name')?.invalid && customerForm.get('name')?.touched"
            styleClass="w-full">
          <label for="name">Full Name *</label>
        </p-floatlabel>
        <small *ngIf="customerForm.get('name')?.hasError('required') && customerForm.get('name')?.touched" 
               class="p-error">Name is required</small>
      </div>

      <div class="form-row">
        <p-floatlabel>
          <input 
            pInputText 
            id="email" 
            formControlName="email" 
            placeholder="Enter your email" 
            type="email"
            [class.ng-invalid]="customerForm.get('email')?.invalid && customerForm.get('email')?.touched"
            styleClass="w-full">
          <label for="email">Email *</label>
        </p-floatlabel>
        <small *ngIf="customerForm.get('email')?.hasError('required') && customerForm.get('email')?.touched" 
               class="p-error">Email is required</small>
        <small *ngIf="customerForm.get('email')?.hasError('email') && customerForm.get('email')?.touched" 
               class="p-error">Please enter a valid email address</small>
      </div>

      <div class="form-row">
        <p-floatlabel>
          <input 
            pInputText 
            id="phone" 
            formControlName="phone" 
            placeholder="Enter your phone number"
            [class.ng-invalid]="customerForm.get('phone')?.invalid && customerForm.get('phone')?.touched"
            styleClass="w-full">
          <label for="phone">Phone Number *</label>
        </p-floatlabel>
        <small *ngIf="customerForm.get('phone')?.hasError('required') && customerForm.get('phone')?.touched" 
               class="p-error">Phone number is required</small>
      </div>

      <div class="form-row">
        <p-floatlabel>
          <input 
            pInputText 
            id="address" 
            formControlName="address" 
            placeholder="Enter your full street address (e.g., 15 Nada Street)"
            [class.ng-invalid]="customerForm.get('address')?.invalid && customerForm.get('address')?.touched"
            styleClass="w-full">
          <label for="address">Street Address *</label>
        </p-floatlabel>
        <small *ngIf="customerForm.get('address')?.hasError('required') && customerForm.get('address')?.touched" 
               class="p-error">Address is required</small>
      </div>

      <div class="form-row">
        <p-floatlabel>
          <input 
            pInputText 
            id="city" 
            formControlName="city" 
            placeholder="Enter your city"
            [class.ng-invalid]="customerForm.get('city')?.invalid && customerForm.get('city')?.touched"
            styleClass="w-full">
          <label for="city">City *</label>
        </p-floatlabel>
        <small *ngIf="customerForm.get('city')?.hasError('required') && customerForm.get('city')?.touched" 
               class="p-error">City is required</small>
      </div>

      <div class="form-row">
        <p-floatlabel>
          <input 
            pInputText 
            id="state" 
            formControlName="state" 
            placeholder="Enter your state or province"
            [class.ng-invalid]="customerForm.get('state')?.invalid && customerForm.get('state')?.touched"
            styleClass="w-full">
          <label for="state">State/Province *</label>
        </p-floatlabel>
        <small *ngIf="customerForm.get('state')?.hasError('required') && customerForm.get('state')?.touched" 
               class="p-error">State is required</small>
      </div>

      <div class="form-row">
        <p-floatlabel>
          <input 
            pInputText 
            id="postalCode" 
            formControlName="postalCode" 
            placeholder="Enter your postal code"
            [class.ng-invalid]="customerForm.get('postalCode')?.invalid && customerForm.get('postalCode')?.touched"
            styleClass="w-full">
          <label for="postalCode">Postal Code *</label>
        </p-floatlabel>
        <small *ngIf="customerForm.get('postalCode')?.hasError('required') && customerForm.get('postalCode')?.touched" 
               class="p-error">Postal code is required</small>
      </div>

      <div class="form-row">
        <p-floatlabel>
          <input 
            pInputText 
            id="selectedDate" 
            [value]="selectedDate | date:'MM/dd/yyyy'" 
            readonly 
            styleClass="w-full">
          <label for="selectedDate">Selected Service Date</label>
        </p-floatlabel>

      </div>

      <div class="order-summary-dialog">
        <p-panel header="Order Summary" styleClass="summary-panel">
          <div class="summary-row">
            <span>Total Items:</span>
            <p-chip [label]="dataService.itemsInCart.toString()"></p-chip>
          </div>
          <div class="summary-row">
            <span>Total Price:</span>
            <p-chip [label]="(totalPrice | currency) || ''" styleClass="price-chip"></p-chip>
          </div>
        </p-panel>
      </div>
    </div>
  </form>
  
  <ng-template pTemplate="footer">
    <div class="dialog-footer">
      <p-button 
        label="Cancel" 
        icon="pi pi-times" 
        (onClick)="cancelOrder()" 
        styleClass="p-button-text">
      </p-button>
      <p-button 
        label="Clear Saved Address" 
        icon="pi pi-trash" 
        (onClick)="clearSavedAddress()" 
        styleClass="p-button-outlined p-button-warning">
      </p-button>
      <p-button 
        label="Submit Order" 
        icon="pi pi-check" 
        (onClick)="submitOrder()" 
        [disabled]="!customerForm.valid"
        styleClass="p-button-success">
      </p-button>
    </div>
  </ng-template>
</p-dialog>

<ng-template #emptyCart>
  <div class="empty-cart">
    <p-card styleClass="empty-cart-card">
      <ng-template pTemplate="header">
        <div class="empty-cart-icon">
          <i class="pi pi-shopping-cart" style="font-size: 4rem; color: #ccc;"></i>
        </div>
      </ng-template>
      
      <ng-template pTemplate="title">
    <h2>Your cart is empty</h2>
      </ng-template>
      
      <ng-template pTemplate="subtitle">
        <p>Browse our services below and add some to get started!</p>
      </ng-template>
      
      <ng-template pTemplate="footer">
        <div class="empty-cart-actions" *ngIf="businessServices.length > 0">
          <p-button 
            label="Browse Services" 
            icon="pi pi-arrow-up" 
            (onClick)="scrollToServices()"
            styleClass="p-button-outlined">
          </p-button>
        </div>
      </ng-template>
    </p-card>
  </div>
</ng-template>

<!-- Reviews Dialog -->
<p-dialog 
  [(visible)]="showReviewsDialog" 
  [modal]="true" 
  [closable]="true" 
  [draggable]="false" 
  [resizable]="false"
  [header]="selectedServiceForReviews?.serviceName + ' - Reviews'"
  styleClass="reviews-dialog"
  [style]="{width: '90vw', maxWidth: '800px', height: '80vh'}">
  
  <app-reviews 
    *ngIf="selectedServiceForReviews && businessInfo?.businessID"
    [serviceId]="selectedServiceForReviews.serviceID" 
    [businessId]="businessInfo!.businessID!"
    [showAddReview]="true">
  </app-reviews>
</p-dialog>